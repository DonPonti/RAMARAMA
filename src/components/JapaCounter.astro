---
// Pure Astro component â€” no props needed, all state is client-side
---

<!-- Counter Display -->
<div class="bg-white/85 dark:bg-gray-800/85 backdrop-blur-sm rounded-2xl shadow-lg border border-saffron-100 dark:border-saffron-900/50 p-5 sm:p-6 mb-4 sm:mb-6">
  <div class="text-center mb-5">
    <div
      id="count-display"
      class="font-display text-4xl sm:text-5xl md:text-6xl text-saffron-600 dark:text-saffron-400 tabular-nums leading-none"
      aria-live="polite"
      aria-atomic="true"
    >0</div>
    <div class="text-sm text-gray-400 dark:text-gray-500 font-body mt-2">Rama Namas written</div>
  </div>

  <div class="mb-2">
    <div class="flex justify-between text-xs font-body text-gray-500 dark:text-gray-400 mb-1.5">
      <span>Progress toward 1 Crore</span>
      <span id="percent-display">0.0000%</span>
    </div>
    <div class="h-3.5 bg-saffron-100 dark:bg-gray-700 rounded-full overflow-hidden">
      <div
        id="progress-bar"
        class="h-full rounded-full transition-all duration-500 bg-gradient-to-r from-saffron-400 to-saffron-600"
        style="width:0%"
        role="progressbar"
        aria-valuenow="0"
        aria-valuemin="0"
        aria-valuemax="100"
      ></div>
    </div>
  </div>
  <div class="text-center text-xs text-gray-400 dark:text-gray-500 font-body mt-1">
    Goal: <span class="text-saffron-500">1,00,00,000</span> (1 Crore)
  </div>
</div>

<!-- Input Tabs -->
<div class="bg-white/85 dark:bg-gray-800/85 backdrop-blur-sm rounded-2xl shadow-lg border border-saffron-100 dark:border-saffron-900/50 p-4 sm:p-6 mb-4 sm:mb-6">

  <!-- Tab Bar -->
  <div class="flex rounded-xl bg-saffron-50 dark:bg-gray-700/60 p-1 mb-5 gap-1">
    <button
      id="tab-type"
      class="tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-lg text-sm font-body font-semibold transition-all bg-white dark:bg-gray-700 text-saffron-700 dark:text-saffron-300 shadow-sm"
      aria-selected="true"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      Type
    </button>
    <button
      id="tab-voice"
      class="tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-lg text-sm font-body font-semibold transition-all text-gray-500 dark:text-gray-400 hover:text-saffron-600 dark:hover:text-saffron-400"
      aria-selected="false"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
      </svg>
      Speak
    </button>
  </div>

  <!-- TYPE PANEL -->
  <div id="panel-type">
    <label for="japa-input" class="block font-body text-sm text-gray-600 dark:text-gray-400 mb-3 text-center">
      Type Sri Rama's name below
    </label>

    <textarea
      id="japa-input"
      class="w-full h-28 sm:h-36 rounded-xl border-2 border-saffron-200 dark:border-saffron-900/60 bg-saffron-50/50 dark:bg-gray-700/50 text-gray-800 dark:text-gray-100 font-serif text-base sm:text-lg p-3 sm:p-4 resize-none focus:outline-none focus:border-saffron-400 dark:focus:border-saffron-500 transition-colors placeholder:text-gray-300 dark:placeholder:text-gray-600"
      placeholder="Sri Rama&#10;Jai Shree Ram&#10;Rama Rama..."
      autocomplete="off"
      spellcheck="false"
      autocorrect="off"
      autocapitalize="none"
      enterkeyhint="done"
      aria-label="Type Sri Rama here"
    ></textarea>

    <!-- BIG COUNT BUTTON for mobile -->
    <button
      id="count-btn"
      class="mt-3 w-full flex items-center justify-center gap-2 py-4 rounded-xl bg-gradient-to-r from-saffron-500 to-saffron-600 text-white font-body font-bold text-base shadow-md hover:shadow-lg hover:from-saffron-600 hover:to-saffron-700 active:scale-95 transition-all min-h-[52px]"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
      </svg>
      Count It! ğŸ™
    </button>

    <!-- feedback message -->
    <div id="count-feedback" class="hidden mt-2 text-center text-sm font-body font-semibold text-saffron-600 dark:text-saffron-400"></div>

    <p class="mt-3 text-xs text-gray-400 dark:text-gray-500 font-body text-center">
      "Sri Rama" Â· "Jai Shree Ram" Â· "Jai Ram" Â· "Rama Rama" Â· "Ram Ram"
    </p>
  </div>

  <!-- VOICE PANEL -->
  <div id="panel-voice" class="hidden">
    <div class="text-center mb-4">

      <div id="voice-status" class="font-body text-sm text-gray-500 dark:text-gray-400 mb-5">
        Press mic and say <strong class="text-saffron-600 dark:text-saffron-400">"Jai Shree Ram"</strong>
      </div>

      <!-- Mic button -->
      <div class="relative inline-flex items-center justify-center mb-4">
        <div id="mic-pulse" class="hidden absolute w-24 h-24 rounded-full bg-saffron-400/25 animate-ping"></div>
        <button
          id="mic-btn"
          class="relative w-20 h-20 rounded-full bg-gradient-to-br from-saffron-400 to-saffron-600 text-white shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center"
          aria-label="Start voice recognition"
        >
          <svg id="mic-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
          </svg>
          <svg id="stop-icon" class="w-7 h-7 hidden" fill="currentColor" viewBox="0 0 24 24">
            <rect x="6" y="6" width="12" height="12" rx="2"/>
          </svg>
        </button>
      </div>

      <!-- Live transcript -->
      <div
        id="voice-transcript"
        class="hidden px-4 py-3 rounded-xl bg-saffron-50 dark:bg-gray-700/50 border-2 border-saffron-100 dark:border-gray-600/50 font-serif text-saffron-700 dark:text-saffron-300 text-center text-sm min-h-[48px] transition-all"
      ></div>

      <!-- Auto-counted badge -->
      <div id="voice-count-badge" class="hidden mt-3 mx-auto w-fit px-4 py-2 rounded-full bg-saffron-500 text-white font-body font-bold text-sm shadow-md">
        âœ“ Counted!
      </div>

      <!-- Not supported -->
      <div id="voice-unsupported" class="hidden mt-3 text-sm text-red-500 dark:text-red-400 font-body bg-red-50 dark:bg-red-900/20 rounded-xl p-3">
        âš ï¸ Voice not supported. Please use Chrome or Edge browser.
      </div>
    </div>

    <p class="text-xs text-gray-400 dark:text-gray-500 font-body text-center">
      Say: "Jai Shree Ram" Â· "Jai Sri Ram" Â· "Rama Rama" Â· "Sri Rama" Â· "Ram Ram"
    </p>
  </div>

  <!-- Session count -->
  <div class="mt-4 flex justify-between items-center">
    <div class="text-xs text-gray-400 dark:text-gray-500 font-body">Today's session</div>
    <div id="session-count" class="text-xs font-body text-saffron-500 dark:text-saffron-400 font-bold">
      +0 this session
    </div>
  </div>
</div>

<!-- Share + Reset -->
<div class="flex gap-3 mb-4 sm:mb-6">
  <button
    id="share-btn"
    class="flex-1 flex items-center justify-center gap-2 py-3.5 px-4 rounded-xl border-2 border-saffron-200 dark:border-saffron-800 text-saffron-600 dark:text-saffron-400 font-body font-semibold text-sm hover:bg-saffron-50 dark:hover:bg-saffron-900/20 transition-all active:scale-95 min-h-[48px]"
  >
    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
    </svg>
    Share
  </button>
  <button
    id="reset-btn"
    class="flex items-center justify-center gap-2 py-3.5 px-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 font-body font-semibold text-sm hover:bg-red-50 dark:hover:bg-red-900/10 hover:border-red-200 hover:text-red-500 transition-all active:scale-95 min-h-[48px]"
    aria-label="Reset count"
  >
    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
    </svg>
    Reset
  </button>
</div>

<!-- Milestone Badges -->
<div class="bg-white/85 dark:bg-gray-800/85 backdrop-blur-sm rounded-2xl border border-saffron-100 dark:border-saffron-900/50 p-4 sm:p-5">
  <h2 class="font-display text-sm text-saffron-600 dark:text-saffron-400 text-center mb-4">Milestones</h2>
  <div class="grid grid-cols-3 gap-2 sm:gap-3">
    {[
      { count: 108,      label: '108',     emoji: 'ğŸŒ¸', desc: 'Ashtottara' },
      { count: 1008,     label: '1,008',   emoji: 'ğŸª·', desc: 'Sahasra'    },
      { count: 10008,    label: '10,008',  emoji: 'ğŸµï¸', desc: 'Ayuta'      },
      { count: 100000,   label: '1 Lakh',  emoji: 'ğŸ”±', desc: 'Laksha'     },
      { count: 1000000,  label: '10 Lakh', emoji: 'â­', desc: 'Niyuta'     },
      { count: 10000000, label: '1 Crore', emoji: 'ğŸ™', desc: 'Koti'       },
    ].map(m => (
      <div
        class="milestone-badge text-center p-2.5 sm:p-3 rounded-xl bg-saffron-50 dark:bg-gray-700/50 border border-saffron-100 dark:border-gray-600/50 opacity-40 transition-all duration-500"
        data-milestone={m.count}
      >
        <div class="text-lg sm:text-xl mb-1">{m.emoji}</div>
        <div class="font-display text-xs text-saffron-700 dark:text-saffron-300 font-bold leading-tight">{m.label}</div>
        <div class="text-xs text-gray-400 dark:text-gray-500 font-body mt-0.5">{m.desc}</div>
      </div>
    ))}
  </div>
</div>

<!-- Celebration Overlay -->
<div id="celebration" class="hidden fixed inset-0 z-50 pointer-events-none flex items-center justify-center px-4">
  <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm rounded-2xl p-8 text-center shadow-2xl border-2 border-saffron-300 dark:border-saffron-600 animate-celebrate w-full max-w-xs">
    <div id="celebration-emoji" class="text-6xl mb-3">ğŸŒ¸</div>
    <div id="celebration-title" class="font-display text-xl text-saffron-700 dark:text-saffron-300 mb-1">Milestone!</div>
    <div id="celebration-text" class="font-body text-gray-600 dark:text-gray-400 text-sm">Sri Rama bless you!</div>
  </div>
</div>

<canvas id="confetti-canvas" class="fixed inset-0 z-40 pointer-events-none hidden"></canvas>

<script>
// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GOAL = 10_000_000;

const PATTERNS = [
  /sri\s*ram[a]?\b/gi,
  /jai\s+shree?\s+ram\b/gi,
  /jai\s+sri\s+ram\b/gi,
  /jai\s+ram\b/gi,
  /ram\s+ram\b/gi,
  /rama\s+rama\b/gi,
];

const MILESTONES: Record<number, [string, string, string]> = {
  108:      ['ğŸŒ¸', 'Ashtottara Shata!',  '108 names â€” blessed beginning!'],
  1008:     ['ğŸª·', 'Sahasra Nama!',       '1,008 names â€” thousand-fold devotion!'],
  10008:    ['ğŸµï¸', 'Ayuta Japa!',         '10,008 names â€” divine grace upon you!'],
  100000:   ['ğŸ”±', 'Lakh Completed!',     '1,00,000 names â€” immense tapas!'],
  1000000:  ['â­', '10 Lakh!',            'Ten lakh names â€” Sri Rama is pleased!'],
  10000000: ['ğŸ™', 'Rama Koti!',          'One Crore! Rama Koti complete! ğŸ‰'],
};

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let totalCount   = parseInt(localStorage.getItem('ramaKotiCount') || '0', 10);
let sessionCount = 0;
let lastLen      = 0;
let isListening  = false;
let recognition: SpeechRecognition | null = null;

// â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = (id: string) => document.getElementById(id)!;
const countEl       = $('count-display');
const pctEl         = $('percent-display');
const barEl         = $('progress-bar');
const sessionEl     = $('session-count');
const textarea      = $('japa-input') as HTMLTextAreaElement;
const countBtn      = $('count-btn');
const countFeedback = $('count-feedback');
const celebEl       = $('celebration');
const celebEmoji    = $('celebration-emoji');
const celebTitle    = $('celebration-title');
const celebText     = $('celebration-text');
const micBtn        = $('mic-btn');
const micIcon       = $('mic-icon');
const stopIcon      = $('stop-icon');
const micPulse      = $('mic-pulse');
const voiceStatus   = $('voice-status');
const transcriptEl  = $('voice-transcript');
const voiceBadge    = $('voice-count-badge');
const unsupported   = $('voice-unsupported');
const tabType       = $('tab-type');
const tabVoice      = $('tab-voice');
const panelType     = $('panel-type');
const panelVoice    = $('panel-voice');

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (n: number) => n.toLocaleString('en-IN');

function countMatches(text: string): number {
  return PATTERNS.reduce((sum, re) => {
    re.lastIndex = 0;
    return sum + (text.match(re)?.length ?? 0);
  }, 0);
}

// â”€â”€â”€ UI update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
  countEl.textContent = fmt(totalCount);
  countEl.classList.remove('animate-count-up');
  void (countEl as HTMLElement).offsetWidth;
  countEl.classList.add('animate-count-up');
  const pct = Math.min((totalCount / GOAL) * 100, 100);
  pctEl.textContent = pct.toFixed(4) + '%';
  barEl.style.width = pct + '%';
  barEl.setAttribute('aria-valuenow', pct.toFixed(2));
  sessionEl.textContent = `+${fmt(sessionCount)} this session`;
}

function unlockMilestones() {
  document.querySelectorAll<HTMLElement>('.milestone-badge').forEach(el => {
    if (totalCount >= Number(el.dataset.milestone)) {
      el.classList.remove('opacity-40');
      el.classList.add('opacity-100', 'ring-2', 'ring-saffron-300');
    }
  });
}

// â”€â”€â”€ Core add count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addCount(n: number, source: 'text' | 'voice' = 'text') {
  if (n <= 0) return;
  const prev   = totalCount;
  totalCount  += n;
  sessionCount += n;
  localStorage.setItem('ramaKotiCount', String(totalCount));
  updateUI();
  unlockMilestones();
  checkMilestones(prev, totalCount);

  if (source === 'voice') {
    voiceBadge.textContent = `âœ“ +${n} Counted!`;
    voiceBadge.classList.remove('hidden');
    setTimeout(() => voiceBadge.classList.add('hidden'), 1500);
  }
}

// â”€â”€â”€ Milestones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkMilestones(prev: number, next: number) {
  for (const ms of Object.keys(MILESTONES).map(Number)) {
    if (prev < ms && next >= ms) { celebrate(ms); break; }
  }
}

function celebrate(ms: number) {
  const [emoji, title, text] = MILESTONES[ms];
  celebEmoji.textContent = emoji;
  celebTitle.textContent = title;
  celebText.textContent  = text;
  celebEl.classList.remove('hidden');
  confetti();
  setTimeout(() => celebEl.classList.add('hidden'), 3800);
}

function confetti() {
  const canvas = $('confetti-canvas') as HTMLCanvasElement;
  const ctx    = canvas.getContext('2d')!;
  canvas.classList.remove('hidden');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  const COLORS  = ['#f97316','#fbbf24','#d4a017','#ef4444','#a855f7','#22c55e'];
  const pieces  = Array.from({ length: 90 }, () => ({
    x: Math.random() * canvas.width,
    y: Math.random() * -200,
    vx: (Math.random() - 0.5) * 4,
    vy: Math.random() * 4 + 2,
    sz: Math.random() * 8 + 4,
    c:  COLORS[Math.floor(Math.random() * COLORS.length)],
    a:  Math.random() * Math.PI * 2,
    va: (Math.random() - 0.5) * 0.2,
  }));
  let f = 0;
  (function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const p of pieces) {
      p.x += p.vx; p.y += p.vy; p.a += p.va;
      ctx.save();
      ctx.translate(p.x, p.y); ctx.rotate(p.a);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.sz / 2, -p.sz / 2, p.sz, p.sz * 0.6);
      ctx.restore();
    }
    if (++f < 130) requestAnimationFrame(draw);
    else { ctx.clearRect(0, 0, canvas.width, canvas.height); canvas.classList.add('hidden'); }
  })();
}

// â”€â”€â”€ TYPING: live count on input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
textarea.addEventListener('input', () => {
  const text = textarea.value;
  const now    = countMatches(text);
  const before = countMatches(text.slice(0, lastLen));
  addCount(Math.max(0, now - before), 'text');
  lastLen = text.length;
  textarea.scrollTop = textarea.scrollHeight;
});

// Catch space/enter explicitly on mobile keyboards
textarea.addEventListener('keydown', (e) => {
  if (e.key === ' ' || e.key === 'Enter') {
    setTimeout(() => {
      const text = textarea.value;
      const now    = countMatches(text);
      const before = countMatches(text.slice(0, lastLen));
      const diff   = Math.max(0, now - before);
      if (diff > 0) { addCount(diff, 'text'); lastLen = text.length; }
    }, 50);
  }
});

// â”€â”€â”€ COUNT IT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
countBtn.addEventListener('click', () => {
  const text    = textarea.value.trim();
  const matched = countMatches(text);

  if (matched > 0) {
    addCount(matched, 'text');
    countFeedback.textContent = `+${matched} counted! ğŸ™`;
    countFeedback.style.color = '';
    countFeedback.classList.remove('hidden');
    textarea.value = '';
    lastLen = 0;
    textarea.focus();
  } else {
    countFeedback.textContent = text
      ? 'Write "Sri Rama" or "Jai Shree Ram" to count'
      : 'Type a name above first!';
    countFeedback.style.color = '#ef4444';
    countFeedback.classList.remove('hidden');
  }

  setTimeout(() => countFeedback.classList.add('hidden'), 2000);
});

// â”€â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpeechAPI = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;

if (SpeechAPI) {
  recognition = new SpeechAPI() as SpeechRecognition;
  recognition.continuous     = true;
  recognition.interimResults = true;
  recognition.lang           = 'hi-IN';

  let finalBuffer  = '';
  let alreadyCounted = '';

  recognition.onresult = (e: SpeechRecognitionEvent) => {
    let interim  = '';
    let newFinal = '';

    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript.trim();
      if (e.results[i].isFinal) newFinal += ' ' + t;
      else interim += t;
    }

    // Show live text
    transcriptEl.classList.remove('hidden');
    transcriptEl.textContent = (interim || newFinal).trim();

    // âœ… AUTO-COUNT on final result immediately
    if (newFinal) {
      const chunk = newFinal.toLowerCase();
      finalBuffer += ' ' + chunk;
      const matched = countMatches(finalBuffer);
      if (matched > 0) {
        addCount(matched, 'voice');
        transcriptEl.classList.add('border-saffron-400', 'bg-saffron-100', 'dark:bg-saffron-900/30');
        setTimeout(() => transcriptEl.classList.remove('border-saffron-400', 'bg-saffron-100', 'dark:bg-saffron-900/30'), 600);
        finalBuffer    = '';
        alreadyCounted = chunk;
      }
    }

    // âœ… ALSO count interim after 700ms pause (catches slow finalization on mobile)
    if (interim && interim.toLowerCase() !== alreadyCounted) {
      clearTimeout((window as any)._interimTimer);
      (window as any)._interimTimer = setTimeout(() => {
        const matched = countMatches(interim.toLowerCase());
        if (matched > 0) {
          addCount(matched, 'voice');
          alreadyCounted = interim.toLowerCase();
        }
      }, 700);
    }
  };

  recognition.onerror = (e: SpeechRecognitionErrorEvent) => {
    const msgs: Record<string, string> = {
      'not-allowed': 'âš ï¸ Mic access denied. Allow it in browser settings.',
      'no-speech':   'ğŸ¤ No speech heard â€” speak closer to your mic.',
      'network':     'âš ï¸ Network error. Check your connection.',
    };
    voiceStatus.textContent = msgs[e.error] || 'âš ï¸ Error. Please try again.';
    stopVoice();
  };

  recognition.onend = () => {
    if (isListening) { try { recognition?.start(); } catch(_) {} }
  };

  micBtn.addEventListener('click', () => isListening ? stopVoice() : startVoice());

  function startVoice() {
    isListening  = true;
    finalBuffer  = '';
    alreadyCounted = '';
    try { recognition!.start(); } catch(_) {}
    micIcon.classList.add('hidden');
    stopIcon.classList.remove('hidden');
    micPulse.classList.remove('hidden');
    micBtn.classList.add('ring-4', 'ring-saffron-300/50');
    voiceStatus.innerHTML = 'ğŸ¤ <strong>Listening...</strong> Say "Jai Shree Ram"';
    transcriptEl.classList.remove('hidden');
    transcriptEl.textContent = '';
  }

  function stopVoice() {
    isListening = false;
    try { recognition!.stop(); } catch(_) {}
    micIcon.classList.remove('hidden');
    stopIcon.classList.add('hidden');
    micPulse.classList.add('hidden');
    micBtn.classList.remove('ring-4', 'ring-saffron-300/50');
    voiceStatus.innerHTML = 'Press mic and say <strong class="text-saffron-600 dark:text-saffron-400">"Jai Shree Ram"</strong>';
    transcriptEl.classList.add('hidden');
    transcriptEl.textContent = '';
  }

} else {
  micBtn.classList.add('opacity-40', 'cursor-not-allowed');
  (micBtn as HTMLButtonElement).disabled = true;
  unsupported.classList.remove('hidden');
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const activeTab   = 'tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-lg text-sm font-body font-semibold transition-all bg-white dark:bg-gray-700 text-saffron-700 dark:text-saffron-300 shadow-sm';
const inactiveTab = 'tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-lg text-sm font-body font-semibold transition-all text-gray-500 dark:text-gray-400 hover:text-saffron-600';

function activateTab(tab: 'type' | 'voice') {
  const isType = tab === 'type';
  tabType.setAttribute('aria-selected',  String(isType));
  tabVoice.setAttribute('aria-selected', String(!isType));
  tabType.className  = isType  ? activeTab : inactiveTab;
  tabVoice.className = !isType ? activeTab : inactiveTab;
  panelType.classList.toggle('hidden',  !isType);
  panelVoice.classList.toggle('hidden', isType);
  if (isType) textarea.focus();
  else if (!SpeechAPI) unsupported.classList.remove('hidden');
}

tabType.addEventListener('click',  () => activateTab('type'));
tabVoice.addEventListener('click', () => activateTab('voice'));

// â”€â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('share-btn').addEventListener('click', async () => {
  const text = `ğŸ™ I've chanted Sri Rama ${fmt(totalCount)} times on Digital Rama Koti!\n\nJoin me: ${location.origin}`;
  if (navigator.share) {
    await navigator.share({ title: 'Digital Rama Koti', text, url: location.origin }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text)
      .then(() => alert('Copied! Share it with devotees ğŸ™'))
      .catch(() => alert(text));
  }
});

// â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('reset-btn').addEventListener('click', () => {
  if (!confirm(`Reset your count?\n\nCurrent: ${fmt(totalCount)} Sri Rama(s)\n\nThis cannot be undone.`)) return;
  totalCount = sessionCount = lastLen = 0;
  textarea.value = '';
  localStorage.removeItem('ramaKotiCount');
  updateUI();
  document.querySelectorAll<HTMLElement>('.milestone-badge').forEach(el => {
    el.classList.remove('opacity-100', 'ring-2', 'ring-saffron-300');
    el.classList.add('opacity-40');
  });
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateUI();
unlockMilestones();
textarea.focus();
</script>
